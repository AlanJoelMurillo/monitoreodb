{% extends "db_monitor/layout.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'db_monitor\css\styleMensajeria.css' %}">
{% endblock %}

{% block app %}
<h1 class="titulo">Mensajería</h1>
<main class="main">
    <form id="status-form">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="change_state">

        <section class="botones">
            <button id="turn-on" class="btn_encender" type="submit" name="state" value="on">Encender</button>    
            <button id="turn-off" class="btn_apagar" type="submit" name="state" value="off">Apagar</button>
        </section>
    </form>
    <section class="forms-select">
        <form id="pause-form" class="select-form">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="pause_messages">

            <label class="select-label">Pausar mensajería</label>
            <select id="pause-select" name="pause" class="select-select">
                <option value="3600">1 hora</option>
                <option value="10800">3 horas</option>
                <option value="28800">8 horas</option>
                <option value="86400">24 horas</option>
            </select>
            <button type="submit" class="select-button">Aplicar</button>
        </form>
        <form id="interval-form" class="select-form">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="change_interval">

            <label class="select-label">frecuencia de monitoreo</label>
            <select id="interval-select" name="interval" class="select-select">
                <option value="60">1 minuto</option>
                <option value="600">10 minutos</option>
                <option value="1800">30 minutos</option>
                <option value="3600">1 hora</option>
            </select>

            <button type="submit" class="select-button">Aplicar</button>
        </form>
    </section>
</main>      
{% endblock %}
{% block scripts %}


<script>
function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }   
    document.getElementById("status-form").addEventListener("submit", async function(e) {
        e.preventDefault()
        const btnOn = document.getElementById("turn-on")
        const btnOff = document.getElementById("turn-off")
        const status = e.submitter.value
        if (status == "on"){
            btnOn.disabled = true
            btnOff.disabled = false
        }
        if (status =="off"){
            btnOff.disabled = true
            btnOn.disabled = false
        }
        try {
            const response = await fetch("{% url 'mensajes' %}",{
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                    },
                body: JSON.stringify({ action:"change_state", value: status })
            })
            const data = await response.json();
            console.log("Respuesta del servidor:", data);
        }catch {    
            console.error("Error al enviar la solicitud.");
            btnOff.disabled = true 
            btnOn.disabled = true
        }    
    
})
    document.getElementById("pause-form").addEventListener("submit",async function (e) {
        e.preventDefault()
        const timePause = document.getElementById("pause-select").value
        try{
            const response = await fetch("{% url 'mensajes' %}",{
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                    },
                body: JSON.stringify({ action:"pause_messages", value: timePause })
            })
            data = await response.json()
            console.log("Respuesta del servidor:", data);

        }
        catch{

        }
        
        
    })
    document.getElementById("interval-form").addEventListener("submit", async function (e){
        e.preventDefault()
        const timeInterval = document.getElementById("interval-select")
        try{
            const response = await fetch("{% url 'mensajes' %}",{
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({action: "change_interval", value: timeInterval })
            })
            data = await response.json()
            console.log("respuesta del servidor: ",data )
        }
        catch{
            console.log("Error")
        }
    })
</script>
{% endblock %}